[
  { "$graphLookup": { "from": "accounts", "startWith": "$_id", "connectFromField": "_id", "connectToField": "parentId", "as": "children" } },
  {
    "$project": {
      "_id": 1,
      "createdOn": 1,
      "updatedOn": 1,
      "name": 1,
      "parentId": 1,
      "childrenIds": "$children._id"
    }
  },
  {
    "$lookup": {
      "from": "transactions",
      "let": { "accountChildrenIds": "$childrenIds", "accountId": "$_id" },
      "pipeline": [
        {
          "$match": {
            "$expr": {
              "$or": [
                {
                  "$eq": [
                    "$sourceAccountId",
                    "$$accountId"
                  ]
                },
                {
                  "$in": [
                    "$sourceAccountId",
                    "$$accountChildrenIds"
                  ]
                }
              ]
            }
          }
        }
      ],
      "as": "outgoingTx"
    }
  },
  {
    "$lookup": {
      "from": "transactions",
      "let": {
        "accountChildrenIds": "$childrenIds",
        "accountId": "$_id"
      },
      "pipeline": [
        {
          "$match": {
            "$expr": {
              "$or": [
                {
                  "$eq": [
                    "$targetAccountId",
                    "$$accountId"
                  ]
                },
                {
                  "$in": [
                    "$targetAccountId",
                    "$$accountChildrenIds"
                  ]
                }
              ]
            }
          }
        }
      ],
      "as": "incomingTx"
    }
  },
  {
    "$addFields": {
      "incoming": {
        "$toDecimal": { "$sum": "$incomingTx.amount" }
      },
      "outgoing": {
        "$toDecimal": { "$sum": "$outgoingTx.amount" }
      }
    }
  },
  {
    "$addFields": {
      "balance": {
        "$subtract": [
          "$incoming",
          "$outgoing"
        ]
      }
    }
  },
  {
    "$project": {
      "incomingTx": 0,
      "outgoingTx": 0,
      "childrenIds": 0
    }
  },
  { "$sort": { "name": -1 } }
]