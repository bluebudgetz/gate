[
  {
    "$graphLookup": {
      "from": "accounts",
      "startWith": "$_id",
      "connectFromField": "_id",
      "connectToField": "parentId",
      "as": "children"
    }
  },
  {
    "$project": {
      "_id": 1,
      "name": 1,
      "parentId": 1,
      "childrenIds": "$children._id"
    }
  },
  {
    "$lookup": {
      "from": "transactions",
      "let": {
        "accountChildrenIds": "$childrenIds",
        "accountId": "$_id"
      },
      "pipeline": [
        {
          "$match": {
            "$expr": {
              "$or": [
                {
                  "$eq": [
                    "$source",
                    "$$accountId"
                  ]
                },
                {
                  "$in": [
                    "$source",
                    "$$accountChildrenIds"
                  ]
                }
              ]
            }
          }
        }
      ],
      "as": "outgoingTx"
    }
  },
  {
    "$lookup": {
      "from": "transactions",
      "let": {
        "accountChildrenIds": "$childrenIds",
        "accountId": "$_id"
      },
      "pipeline": [
        {
          "$match": {
            "$expr": {
              "$or": [
                {
                  "$eq": [
                    "$target",
                    "$$accountId"
                  ]
                },
                {
                  "$in": [
                    "$target",
                    "$$accountChildrenIds"
                  ]
                }
              ]
            }
          }
        }
      ],
      "as": "incomingTx"
    }
  },
  {
    "$addFields": {
      "incoming": {
        "$sum": "$incomingTx.amount"
      },
      "outgoing": {
        "$sum": "$outgoingTx.amount"
      }
    }
  },
  {
    "$addFields": {
      "balance": {
        "$subtract": [
          "$incoming",
          "$outgoing"
        ]
      }
    }
  },
  {
    "$project": {
      "incomingTx": 0,
      "outgoingTx": 0,
      "childrenIds": 0
    }
  }
]